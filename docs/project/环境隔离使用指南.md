# Cryptofeed 环境隔离使用指南

## 📋 概述

本项目支持**开发环境**和**生产环境**完全隔离，避免相互干扰。

---

## 🌍 两个环境对比

| 项目 | 开发环境（dev） | 生产环境（prod） |
|------|----------------|-----------------|
| **配置文件** | `config/dev.yaml` | `config/prod.yaml` |
| **API 端口** | 8889 | 8888 |
| **健康检查端口** | 8081 | 8080 |
| **数据库名** | cryptofeed_dev | cryptofeed |
| **交易对数量** | 2 个（BTC、ETH） | 5 个（完整列表） |
| **数据保留** | 7-90 天（短期） | 30-1095 天（长期） |
| **日志级别** | DEBUG | INFO |
| **自动回填** | 禁用 | 启用 |
| **启动方式** | PyCharm 或命令行 | Docker |

---

## 🚀 使用方法

### 方式 1：开发环境启动（PyCharm）

#### 步骤 1：激活 Conda 环境

```bash
source /opt/anaconda3/etc/profile.d/conda.sh
conda activate cryptofeed
```

#### 步骤 2：启动开发环境

```bash
# 方式 A：直接启动（默认就是开发环境）
python main.py

# 方式 B：明确指定环境
ENV=dev python main.py

# 方式 C：使用模块方式
python -m cryptofeed_api.app
```

#### 步骤 3：验证启动成功

启动后会看到：

```
🔧 Environment: dev
📄 Config file: config/dev.yaml
🌐 API Port: 8889
🗄️  Database: cryptofeed_dev
🏥 Health Check Port: 8081
```

#### 步骤 4：访问开发环境

- **API 文档**：http://localhost:8889/docs
- **健康检查**：http://localhost:8081/health
- **监控指标**：http://localhost:8081/metrics

---

### 方式 2：生产环境启动（Docker）

#### 步骤 1：修改 Docker Compose 文件

编辑 `docker-compose.yml`，添加环境变量：

```yaml
services:
  cryptofeed-api:
    environment:
      - ENV=prod  # 指定生产环境
```

#### 步骤 2：启动生产环境

```bash
# 启动 Docker 容器
docker-compose up -d

# 查看日志
docker-compose logs -f cryptofeed-api
```

#### 步骤 3：验证启动成功

日志中会看到：

```
🔧 Environment: prod
📄 Config file: config/prod.yaml
🌐 API Port: 8888
🗄️  Database: cryptofeed
🏥 Health Check Port: 8080
```

#### 步骤 4：访问生产环境

- **API 文档**：http://localhost:8888/docs
- **健康检查**：http://localhost:8080/health
- **监控指标**：http://localhost:8080/metrics

---

## 🔄 同时运行两个环境

**完全支持！** 两个环境使用不同端口和数据库，可以同时运行：

```bash
# 终端 1：启动开发环境
ENV=dev python main.py

# 终端 2：启动生产环境（Docker）
docker-compose up
```

**访问：**
- 开发环境：http://localhost:8889/docs
- 生产环境：http://localhost:8888/docs

---

## 🛠️ PyCharm 配置

### 配置开发环境运行

1. **打开 Run/Debug Configurations**
2. **选择 Python**
3. **配置如下**：

```
名称：Cryptofeed Dev
脚本路径：/Volumes/磁盘/Projects/cryptofeed/main.py
工作目录：/Volumes/磁盘/Projects/cryptofeed
Python 解释器：cryptofeed (conda)
环境变量：ENV=dev
```

4. **点击 Apply → OK**

5. **点击绿色运行按钮启动**

---

## 📊 验证环境隔离

### 检查 1：端口分离

```bash
# 查看开发环境端口
lsof -i:8889  # 应该看到 python 进程

# 查看生产环境端口
lsof -i:8888  # 应该看到 docker 进程
```

### 检查 2：数据库分离

```bash
# 连接到 ClickHouse
docker exec -it cryptofeed-clickhouse clickhouse-client

# 查看数据库列表
SHOW DATABASES;
```

应该看到两个数据库：
- `cryptofeed_dev` （开发环境）
- `cryptofeed` （生产环境）

### 检查 3：数据不混淆

```bash
# 开发环境：查看 BTC 数据
# 访问 http://localhost:8889/api/v1/trades?symbol=BTC-USDT-PERP

# 生产环境：查看 BTC 数据
# 访问 http://localhost:8888/api/v1/trades?symbol=BTC-USDT-PERP
```

两者的数据应该是独立的。

---

## 🔧 常见问题

### 问题 1：端口被占用

**错误信息：**
```
ERROR: [Errno 48] error while attempting to bind on address ('0.0.0.0', 8889): address already in use
```

**解决方法：**
```bash
# 查找占用端口的进程
lsof -i:8889

# 杀死进程
kill -9 <PID>
```

---

### 问题 2：配置文件未找到

**错误信息：**
```
⚠️  Warning: Config file not found: config/dev.yaml
```

**解决方法：**
```bash
# 检查文件是否存在
ls -la config/

# 如果不存在，说明文件被误删了，需要重新创建
```

---

### 问题 3：数据库连接失败

**错误信息：**
```
Failed to connect to ClickHouse
```

**解决方法：**
```bash
# 检查 ClickHouse 是否启动
docker ps | grep clickhouse

# 如果没有启动，启动容器
docker start cryptofeed-clickhouse

# 检查数据库是否存在
docker exec -it cryptofeed-clickhouse clickhouse-client
CREATE DATABASE IF NOT EXISTS cryptofeed_dev;
```

---

### 问题 4：忘记当前是哪个环境

**查看方法：**
```bash
# 查看启动日志的第一行
# 会显示：🔧 Environment: dev 或 🔧 Environment: prod

# 或者访问 API 查看
curl http://localhost:8889/ | grep environment
```

---

## 📝 切换环境的最佳实践

### 开发流程

```bash
# 1. 在开发环境测试新功能
ENV=dev python main.py

# 2. 测试通过后，提交代码
git add .
git commit -m "feat: 新功能"

# 3. 在生产环境部署
docker-compose restart

# 4. 验证生产环境正常
curl http://localhost:8888/api/v1/health
```

### 调试流程

```bash
# 1. 在开发环境复现问题
ENV=dev python main.py

# 2. 修改代码并测试

# 3. 确认修复后，部署到生产环境
```

---

## 🎯 环境变量完整列表

| 变量名 | 开发环境 | 生产环境 | 说明 |
|--------|---------|---------|------|
| `ENV` | `dev` | `prod` | 环境标识 |
| `CLICKHOUSE_HOST` | `localhost` | `localhost` | 数据库地址 |
| `CLICKHOUSE_PORT` | `8123` | `8123` | 数据库端口 |
| `CLICKHOUSE_DATABASE` | `cryptofeed_dev` | `cryptofeed` | 数据库名 |

---

## ✅ 验收标准

环境隔离成功的标志：

- ✅ 两个环境可以同时运行
- ✅ 开发环境使用 8889 端口
- ✅ 生产环境使用 8888 端口
- ✅ 数据写入不同的数据库
- ✅ 修改开发环境配置不影响生产环境

---

## 📚 相关文档

- `config/dev.yaml` - 开发环境配置文件
- `config/prod.yaml` - 生产环境配置文件
- `cryptofeed_api/core/config.py` - 配置管理器实现
- `docs/project/渐进式重构计划.md` - 重构计划（阶段1-任务1）

---

**最后更新**：2025-01-01
**作者**：Claude Code
**版本**：v1.0
